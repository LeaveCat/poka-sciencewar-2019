from pwn import *

'''
Easy_VM - part 1 (Rev)

- trap
	- self jump
	- fake indexing (e.g get flag value over 31 index)

- FLAG
	POKA{W0W_V3ry_N1ce_@nd_G0_Deep!}
'''


ins = {
	"noop" : 0,
	"iadd" : 1,
	"isub" : 2,
	"imul" : 3,
	"idiv" : 4,
	"irem" : 5,
	"ixor" : 6,
	"ilt" : 7,
	"ieq" : 8,
	"br" : 9,
	"brt" : 10,
	"brf" : 11,
	"iconst" : 12,
	"load" : 13,
	"gload" : 14,
	"store" : 15,
	"gstore" : 16,
	"print" : 17,
	"pop" : 18,
	"call" : 19,
	"ret" : 20,
	"halt" : 21	
}


cmd = [
	# logic 0  globals[0:3] == "POKA" 
	ins["gload"], 0,
	ins["iconst"], 80,
	ins["ieq"],
	ins["brt"], 8,
	ins["halt"],    # 7

	ins["gload"], 1,
	ins["iconst"], 79,
	ins["ieq"],
	ins["brt"], 16,
	ins["halt"],    # 15

	ins["gload"], 2,
	ins["iconst"], 75,
	ins["ieq"],
	ins["brf"], 7,

	ins["gload"], 3,
	ins["iconst"], 65,
	ins["ieq"],
	ins["brf"], 15,

	ins["iconst"], 77777,
	ins["print"],
	# logic 0

	# logic 1 print ((globals[4] * globals[8]) ^ (31337 ^ (globals[12])) ^ (globals[16])) ^ 96263 
	ins["gload"], 4,
	ins["gload"], 8,
	ins["imul"],
	ins["iconst"], 31337,
	ins["gload"], 12,
	ins["ixor"],
	ins["ixor"],
	ins["gload"], 16,
	ins["ixor"],
	ins["iconst"], 96263,
	ins["ixor"],
	ins["print"],
	# logic 1

	# logic 2 print (((globals[7] ^ globals[11]) * globals[15]) * globals[19]) - 38255
	ins["gload"], 7,
	ins["gload"], 11,
	ins["ixor"],
	ins["gload"], 15,
	ins["imul"],
	ins["gload"], 19,
	ins["imul"],
	ins["iconst"], 38255,
	ins["isub"],
	ins["print"],
	# logic 2

	# 31337 - 1 (globals[28]*3) * globals[29] - 2599
	ins["gload"], 28,
	ins["iconst"], 3,
	ins["imul"],
	ins["gload"], 29,
	ins["imul"],
	ins["iconst"], 2599,
	ins["isub"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brf"], 15,
	# 31337 - 1

	# 31337 - 2 (globals[6] ^ globals[7]) + 31234 
	ins["gload"], 6,
	ins["gload"], 7,
	ins["ixor"],
	ins["iconst"], 31234,
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 97,
	ins["br"], 95, # self jump # 95
	# 31337 - 2

	# 31337 - 3 ((globals[10] * globals[11]) * 6) - 3547
	ins["gload"], 10,
	ins["gload"], 11,
	ins["imul"],
	ins["iconst"], 6,
	ins["imul"],
	ins["iconst"], 3547,
	ins["isub"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brf"], 95,
	# 31337 - 3

	# 31337 - 4 (globals[12] * globals[13] * 3) - 3148 
	ins["gload"], 12,
	ins["gload"], 13,
	ins["imul"],
	ins["iconst"], 3,
	ins["imul"],
	ins["iconst"], 3148,
	ins["isub"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brf"], 15,
	# 31337 - 4

	# logic 3 ((globals[5] * globals[9]) * 10) + 2957 # with fake indexing
	ins["gload"], 5,
	ins["gload"], 9,
	ins["imul"],
	ins["iconst"], 10,
	ins["imul"],
	ins["iconst"], 2957,
	ins["iadd"],
	ins["gload"], 32,
	ins["iadd"],
	ins["print"],
	ins["br"], 162,
	# logic 3

	# sub and check 31337 function 
	# pc 146
	ins["load"], 1,
	ins["load"], 0,
	ins["isub"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 159,
	ins["iconst"], 0,
	ins["ret"],
	ins["iconst"], 1,
	ins["ret"],
	# sub and check 31337 function

	# 31337 - 5 (globals[24] * (globals[25] * 7)) - 583
	ins["gload"], 24,
	ins["gload"], 25,
	ins["imul"],
	ins["iconst"], 7,
	ins["imul"],
	ins["iconst"], 583,
	ins["call"], 146, 2, 0,
	ins["iconst"], 1,
	ins["ieq"],
	ins["brf"], 95,
	# 31337 - 5

	ins["br"], 185,
	# self jump 183
	ins["br"], 183,
	# pc 185

	# 31337 - 6 (3121 * 10) + (globals[14] ^ globals[15])
	ins["iconst"], 3121,
	ins["iconst"], 10,
	ins["imul"],
	ins["gload"], 14,
	ins["gload"], 15,
	ins["ixor"],
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brf"], 183,
	# 31337 - 6

	# logic 4 (((globals[22] + globals[26]) * globals[30]) * 14) + 2471
	ins["gload"], 22,
	ins["gload"], 26,
	ins["iadd"],
	ins["gload"], 30,
	ins["imul"],
	ins["iconst"], 14,
	ins["imul"],
	ins["iconst"], 2471,
	ins["iadd"],
	ins["print"],
	# logic 4

	# logic 5 ((globals[20] * globals[28]) + 1) * 7
	ins["gload"], 20,
	ins["gload"], 28,
	ins["imul"],
	ins["iconst"], 1,
	ins["iadd"],
	ins["iconst"], 7,
	ins["imul"],
	ins["print"],
	# logic 5


	# 31337 - 7 (globals[30] * 40) * (globals[31] ^ 100) - 1663
	ins["gload"], 30,
	ins["iconst"], 40,
	ins["imul"],
	ins["gload"], 31,
	ins["iconst"], 100,
	ins["ixor"],
	ins["imul"],
	ins["iconst"], 1663,
	ins["call"], 146, 2, 0,
	ins["iconst"], 1,
	ins["ieq"],
	ins["brf"], 95,
	# 31337 - 7

	# 31337 - 8 ((globals[18] ^ globals[19]) * 1000) + 337
	ins["gload"], 18,
	ins["gload"], 19,
	ins["ixor"],
	ins["iconst"], 1000,
	ins["imul"],
	ins["iconst"], 337,
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 267,
	ins["ret"],
	# 31337 - 8

	# logic 6 print ((globals[13] * globals[17]) * 7 ) + (globals[21] + globals[25] + 10417)
	ins["gload"], 13,
	ins["gload"], 17,
	ins["imul"],
	ins["iconst"], 7,
	ins["imul"],
	ins["gload"], 21,
	ins["gload"], 25,
	ins["iadd"],
	ins["iconst"], 10417,
	ins["iadd"],
	ins["iadd"],
	ins["print"],
	# logic 6

	# 31337 - 9 ((globals[20] * globals[21]) * 3) - 1663 
	ins["gload"], 20,
	ins["gload"], 21,
	ins["imul"],
	ins["iconst"], 3,
	ins["imul"],
	ins["iconst"], 1663,
	ins["call"], 146, 2, 0,
	ins["iconst"], 1,
	ins["ieq"],
	ins["brf"], 95,
	# 31337 - 9

	# 31337 - 10 (globals[4] * globals[5]) + 20636 
	ins["gload"], 4,
	ins["gload"], 5,
	ins["imul"],
	ins["iconst"], 20636,
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 318,
	ins["halt"],
	# 31337 - 10

	# logic 7 print ((globals[23] * globals[27]) * 11) - (globals[31]*9)+ 21
	ins["gload"], 23,
	ins["gload"], 27,
	ins["imul"],
	ins["iconst"], 11,
	ins["imul"],
	ins["gload"], 31,
	ins["iconst"], 9,
	ins["imul"],
	ins["isub"],
	ins["iconst"], 21,
	ins["iadd"],
	ins["print"],
	# logic 7

	# 31337 - 11 31313 + (globals[22] % globals[23])
	ins["iconst"], 31313,
	ins["gload"], 22,
	ins["gload"], 23,
	ins["irem"],
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 350,
	ins["halt"],
	# 31337 - 11 

	# 31337 - 12 ((globals[26] * globals[27]) * 5) - 3003
	ins["gload"], 26,
	ins["gload"], 27,
	ins["imul"],
	ins["iconst"], 5,
	ins["imul"],
	ins["iconst"], 3003,
	ins["isub"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brf"], 183,
	# 31337 - 12	


	# logic 8 print ((globals[24]*1000) ^ (globals[29] * 133)) + 44577
	ins["gload"], 24,
	ins["iconst"], 1000,
	ins["imul"],
	ins["gload"], 29,
	ins["iconst"], 133,
	ins["imul"],
	ins["ixor"],
	ins["iconst"], 44577,
	ins["iadd"],
	ins["print"],
	# logic 8

	# 31337 - 13 (globals[16] * globals[17] * 4) - 8659
	ins["gload"], 16,
	ins["gload"], 17,
	ins["imul"],
	ins["iconst"], 4,
	ins["imul"],
	ins["iconst"], 8659,
	ins["call"], 146, 2, 0,
	ins["iconst"], 1,
	ins["ieq"],
	ins["brf"], 183,
	# 31337 - 13

	# 31337 - 14 (( globals[8] ^ globals[9]) * 3481) + 8 
	ins["gload"], 8,
	ins["gload"], 9,
	ins["ixor"],
	ins["iconst"], 3481,
	ins["imul"],
	ins["iconst"], 8,
	ins["iadd"],
	ins["iconst"], 31337,
	ins["ieq"],
	ins["brt"], 417,
	ins["halt"],
	# 31337 - 14 

	# logic 9 print ((((globals[6] * globals[10]) * globals[14]) / globals[18]) * 50 ) - 22673
	ins["gload"], 6,
	ins["gload"], 10,
	ins["imul"],
	ins["gload"], 14,
	ins["imul"],
	ins["gload"], 18,
	ins["idiv"],
	ins["iconst"], 50,
	ins["imul"],
	ins["iconst"], 22673,
	ins["isub"],
	ins["print"],
	# logic 9
]

print "now pc :: ", len(cmd)

cmd+=[
	ins["halt"],
]

data = ", ".join(map(str, cmd))
data += "\n"

with open("./rev.txt", "w+") as fd:
	fd.write(data)
fd.close()

r = process(["./vm", "-f", "./rev.txt", "-i", 'POKA{W0W_V3ry_N1ce_@nd_G0_Deep!}'])
r.interactive()

